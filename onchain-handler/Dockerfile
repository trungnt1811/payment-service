# Use ARG for build-time variables
ARG GO_VERSION=1.22.4
FROM golang:${GO_VERSION}-alpine

# Install PostgreSQL client
RUN apk add --no-cache postgresql-client

WORKDIR /build

COPY go.mod .
COPY go.sum .

RUN go mod download

COPY . .

# Set runtime environment variables with ENV
ENV DB_USER=${DB_USER}
ENV DB_PASSWORD=${DB_PASSWORD}
ENV DB_HOST=${DB_HOST}
ENV DB_PORT=${DB_PORT}
ENV DB_NAME=${DB_NAME}
ENV RPC_URL=${RPC_URL}
ENV CHAIN_ID=${CHAIN_ID}
ENV START_BLOCK_LISTENER=${START_BLOCK_LISTENER}
ENV LIFE_POINT_CONTRACT_ADDRESS=${LIFE_POINT_CONTRACT_ADDRESS}
ENV USDT_CONTRACT_ADDRESS=${USDT_CONTRACT_ADDRESS}
ENV BULK_SENDER_CONTRACT_ADDRESS=${BULK_SENDER_CONTRACT_ADDRESS}
ENV LP_TREASURY_ADDRESS=${LP_TREASURY_ADDRESS}
ENV USDT_TREASURY_ADDRESS=${USDT_TREASURY_ADDRESS}
ENV LP_COMMUNITY_ADDRESS=${LP_COMMUNITY_ADDRESS}
ENV LP_REVENUE_ADDRESS=${LP_REVENUE_ADDRESS}
ENV LP_STAKING_ADDRESS=${LP_STAKING_ADDRESS}

# Build the Go application
RUN CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o onchain-handler ./cmd

EXPOSE 8080

# The command to run the application
CMD ["./onchain-handler"]
